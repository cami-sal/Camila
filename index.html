<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Population growth by country (UNESCO) — line chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    body { background: #fff9c4; /* light yellow */ display:flex; align-items:center; justify-content:center; }
    #chart-wrap { width: 95vw; height: 90vh; box-shadow: 0 6px 20px rgba(0,0,0,0.08); background: rgba(255,255,255,0.0); border-radius:8px; padding:10px; }
    svg { width:100%; height:100%; overflow:visible; }
    .axis line, .axis path { stroke: #666; opacity: .6; }
    .line { fill: none; stroke-width: 1.6px; opacity: 0.85; cursor: pointer; transition: stroke-width 0.12s, opacity 0.12s; }
    .line:hover { stroke-width: 3.5px; opacity: 1; }
    .grid line { stroke: #e6e6e6; }
    .tooltip {
      position: absolute;
      pointer-events: none;
      font-weight: 700;
      font-size: 28px;
      color: #222;
      text-shadow: 0 1px 0 #fff;
      transform: translate(-50%, -120%);
      white-space: nowrap;
      background: rgba(255,255,255,0.75);
      padding: 6px 12px;
      border-radius: 6px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      display: none;
    }
    .caption { position:absolute; left:12px; top:8px; font-size:13px; color:#333; opacity:.8; }
  </style>
</head>
<body>
  <div id="chart-wrap">
    <div class="caption">Population growth (%) — lines by country code (hover to show country)</div>
    <svg id="svg"></svg>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <script>
  // Config
  const margin = {top: 48, right: 30, bottom: 40, left: 60};
  const svgEl = d3.select("#svg");
  const width = svgEl.node().clientWidth - margin.left - margin.right;
  const height = svgEl.node().clientHeight - margin.top - margin.bottom;

  const svg = svgEl
    .attr("viewBox", \`0 0 \${svgEl.node().clientWidth} \${svgEl.node().clientHeight}\`)
    .append("g")
    .attr("transform", \`translate(\${margin.left},\${margin.top})\`);

  const tooltip = d3.select("#tooltip");

  // Load the uploaded data.json (place it in same folder)
  d3.json("data.json").then(raw => {
    // raw.records is expected
    const records = raw.records || [];

    // Group by geoUnit (country code)
    const nested = d3.group(records, d => d.geoUnit);

    // Convert nested map to array of {id, values:[{year,value},...]}
    const countries = Array.from(nested, ([id, recs]) => {
      const vals = recs
        .filter(r => r.value !== null && r.year !== null)
        .map(r => ({ year: +r.year, value: +r.value }))
        .sort((a,b) => a.year - b.year);
      return { id, values: vals };
    }).filter(d => d.values.length > 0);

    // X and Y domains
    const years = Array.from(new Set(records.map(d => d.year))).sort((a,b)=>a-b);
    const x = d3.scaleLinear()
      .domain(d3.extent(years))
      .range([0, width]);

    const y = d3.scaleLinear()
      .domain([ d3.min(countries, c => d3.min(c.values, v => v.value)) - 1,
                d3.max(countries, c => d3.max(c.values, v => v.value)) + 1 ])
      .nice()
      .range([height, 0]);

    // Color scale: many categories - use interpolated rainbow
    const color = d3.scaleOrdinal()
      .domain(countries.map(d => d.id))
      .range(d3.quantize(d3.interpolateRainbow, countries.length));

    // Axes and grid
    const xAxis = d3.axisBottom(x).ticks(years.length/2).tickFormat(d3.format("d"));
    const yAxis = d3.axisLeft(y);

    svg.append("g")
      .attr("class","grid")
      .selectAll("line")
      .data(y.ticks(6))
      .join("line")
      .attr("x1",0).attr("x2",width)
      .attr("y1",d => y(d)).attr("y2",d => y(d))
      .style("stroke","#f0f0f0");

    svg.append("g")
      .attr("class","axis")
      .attr("transform", \`translate(0,\${height})\`)
      .call(xAxis)
      .selectAll("text")
      .attr("font-size",11);

    svg.append("g")
      .attr("class","axis")
      .call(yAxis)
      .selectAll("text")
      .attr("font-size",11);

    // Line generator
    const line = d3.line()
      .defined(d => d.value != null)
      .x(d => x(d.year))
      .y(d => y(d.value))
      .curve(d3.curveMonotoneX);

    // Draw lines
    const lines = svg.append("g").attr("class","lines")
      .selectAll("path")
      .data(countries)
      .join("path")
      .attr("class","line")
      .attr("d", d => line(d.values))
      .attr("stroke", d => color(d.id))
      .attr("data-id", d => d.id)
      .on("mouseover", function(event, d) {
        // highlight
        d3.select(this).raise().classed("hover", true);
        tooltip.style("display", "block").text(d.id).style("font-size","28px");
      })
      .on("mousemove", function(event, d) {
        // position tooltip at mouse within page
        const [mx, my] = d3.pointer(event);
        // compute absolute page coords
        const wrapRect = document.getElementById('chart-wrap').getBoundingClientRect();
        const pageX = wrapRect.left + margin.left + mx;
        const pageY = wrapRect.top + margin.top + my;
        tooltip
          .style("left", pageX + "px")
          .style("top", pageY + "px")
          .style("display", "block")
          .style("font-size", "28px")
          .style("transform", "translate(-50%, -120%)")
          .text(d.id);
      })
      .on("mouseout", function(event, d) {
        d3.select(this).classed("hover", false);
        tooltip.style("display", "none");
      });

    // OPTIONAL: small dots at points (for visibility)
    svg.append("g").attr("class","points")
      .selectAll("g")
      .data(countries)
      .join("g")
      .attr("fill", d => color(d.id))
      .selectAll("circle")
      .data(d => d.values.map(v => ({id:d.id, v})))
      .join("circle")
      .attr("cx", d => x(d.v.year))
      .attr("cy", d => y(d.v.value))
      .attr("r", 1.2)
      .attr("opacity", 0.6);

    // Responsive resize handling: recompute viewBox when parent size changes
    function resize() {
      const w = svgEl.node().clientWidth - margin.left - margin.right;
      const h = svgEl.node().clientHeight - margin.top - margin.bottom;
      x.range([0, w]); y.range([h, 0]);
      svg.selectAll(".grid line").attr("x2", w).attr("y1", d => y(d)).attr("y2", d => y(d));
      svg.selectAll(".axis").remove();
      svg.append("g").attr("class","axis").attr("transform", \`translate(0,\${h})\`).call(d3.axisBottom(x).ticks(years.length/2).tickFormat(d3.format("d")));
      svg.append("g").attr("class","axis").call(d3.axisLeft(y));
      svg.selectAll(".line").attr("d", d => d3.line().defined(d2 => d2.value!=null).x(d2 => x(d2.year)).y(d2 => y(d2.value)).curve(d3.curveMonotoneX)(d.values));
      svg.selectAll(".points circle").attr("cx", d => x(d.v.year)).attr("cy", d => y(d.v.value));
    }

    window.addEventListener("resize", () => {
      // small debounce
      clearTimeout(window._resizetimer);
      window._resizetimer = setTimeout(resize, 120);
    });

  }).catch(err => {
    console.error("Failed loading data.json:", err);
    d3.select("#chart-wrap").append("div").style("color","red").text("Error loading data.json. Put the file next to index.html (same folder).");
  });

  </script>
</body>
</html>
